---
title: "ZOOTask_EDA_modeling_11.07.23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#  `echo = FALSE` to prevent printing of the R code that generated the plot.
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r}

# Load required packages

# install.packages("dplyr")
# install.packages("Hmisc")
library(dplyr)
library(Hmisc)
library(ggplot2, quietly = TRUE, warn.conflicts = FALSE)
library(emmeans, quietly = TRUE, warn.conflicts = FALSE)
library(lsmeans, quietly = TRUE, warn.conflicts = FALSE)
library(effects, quietly = TRUE, warn.conflicts = FALSE)
library(nlme, quietly = TRUE, warn.conflicts = FALSE)
library(lme4, quietly = TRUE, warn.conflicts = FALSE)
library(lmerTest, quietly = TRUE, warn.conflicts = FALSE)
library(sjPlot, quietly = TRUE, warn.conflicts = FALSE)
library(stats, quietly = TRUE, warn.conflicts = FALSE)
library(dplyr, quietly = TRUE, warn.conflicts = FALSE)

```

# LOAD ZOO DATAFRAME
```{r}
ZOO <- read.csv(file = '/Users/aysuerdemir/Desktop/R workspace/ERP_Zoo/CrossSectional/Mix/ZOO.csv')
# Remove the added X variable after reading it back into R:
ZOO <- ZOO %>%
  dplyr::select(-X)
# Display the first 6 rows of te final dataset:
head(ZOO)
```

# LOAD ZOO_GOOD DATAFRAME
```{r}
ZOO_good <- read.csv(file = '/Users/aysuerdemir/Desktop/R workspace/ERP_Zoo/CrossSectional/Mix/ZOO_good.csv')
# Remove the added X variable after reading it back into R:
ZOO_good <- ZOO_good %>%
  dplyr::select(-X)
# Display the first 6 rows of te final dataset:
head(ZOO_good)
print(names(ZOO_good))
```
# CREATE DATASETS FOR:
1) ERP and BEHAVIORAL ANALYSES --> ZOO_FCz_Pz
2) AGE-GENDER ANALYSES --> ZOO_age_gender

```{r}

# DATAFRAME FOR ERP and BEHAVIORAL ANALYSES:
ZOO_FCz_Pz <- subset(ZOO_good, (Laterality == "Midline"))
rownames(ZOO_FCz_Pz) <- NULL # reset index

# DATAFRAME FOR AGE-GENDER ANALYSE ANALYSES:
# Create a dataset with only 1 entry for each subject:
# Pick one condition - randomly -  because we are only working on age and gender for this one:
ZOO_age_gender <- subset(ZOO_FCz_Pz, (StimTag == "NegGo"))
rownames(ZOO_age_gender) <- NULL # reset index


```

# DISCRIPTIVE STATISTICS FOR AGE, GENDER

```{r}

# Give Age, Gender and Count Summary Statistics for each Group:
ZOO_age_gender_summary <- 
  ZOO_age_gender %>%
  group_by(talkergroup_final) %>%
summarise(
    age = mean(calculator_age_cve, na.rm = TRUE),
    min_age = min(calculator_age_cve, na.rm = TRUE),
    max_age = max(calculator_age_cve, na.rm = TRUE),
    gender = mean(calculator_gender_cve, na.rm = TRUE),
    SD_age = sd(calculator_age_cve, na.rm = TRUE),
    Count_kids = n_distinct(Subject)
    )
print(ZOO_age_gender_summary)



# Histogram of Age across all participants
hist(ZOO_age_gender$calculator_age_cve, 
     main = "Histogram of Age",
     xlab = "age in months",
     ylab = "Frequency",
     col = "blue",        # Color of bars
     border = "black",    # Border color of bars
     # xlim = c(min_value, max_value),  # Adjust the x-axis limits if needed
     breaks = 12)  

# print(quantile(ZOO$calculator_age_cve, 0.50, na.rm = TRUE),)

# CREATE TWO PLOTS FOR CWS AND CWNS
# Create a new plot
par(mfrow=c(1,2))  # This sets up a 1x2 grid for side-by-side histograms
# Histogram for talkergroup_final == 1
hist(ZOO_age_gender$calculator_age_cve[ZOO_age_gender$talkergroup_final == 0], 
     main = "Histogram for CWNS",
     xlab = "age in months",
     ylab = "Frequency",
     col = "blue",
     border = "black",
     xlim = c(30, 100), 
     breaks = 12)
# Histogram for talkergroup_final == 2
hist(ZOO_age_gender$calculator_age_cve[ZOO_age_gender$talkergroup_final == 1], 
     main = "Histogram for CWS",
     xlab = "age in months",
     ylab = "Frequency",
     col = "red",  # Use a different color for the second group
     border = "black",
     xlim = c(30, 100), 
     breaks = 12)
# Reset the plotting to a single plot
par(mfrow=c(1,1))


# MAKE SURE AGE DOES NOT DIFFER BETWEEN GROUPS USING ANOVA
model <- aov (calculator_age_cve ~ talkergroup_final, data = ZOO_age_gender)
anova(model)

# MAKE SURE AGE DOES NOT DIFFER BETWEEN GROUPS USING T-Test  
# Subset the data into two groups based on talkergroup_final
group_CWNS <- ZOO_age_gender$calculator_age_cve[ZOO_age_gender$talkergroup_final == 0]
group_CWS <- ZOO_age_gender$calculator_age_cve[ZOO_age_gender$talkergroup_final == 1]
# Perform a two-sample t-test
t_test_result <- t.test(group_CWNS, group_CWS, alternative = "two.sided")
# Display the t-test result
print(t_test_result)

```

# BEHAVIORAL DATA SUMMARY STATISTICS

```{r}
# Histogram of Accuracy, premature_responses, and RT_proper

summary_behavioral_hist <-
  ZOO_FCz_Pz %>%
  group_by(Subject, talkergroup_final, StimTag) %>%
  summarise(Average_accuracy = mean(accuracy, na.rm = TRUE), 
            Average_premature_responses = mean(premature_responses, na.rm = TRUE),
            Average_RT = mean(RT_proper, na.rm = TRUE))
print(summary_behavioral_hist)

# Accuracy Histogram:
# Create a new plot
par(mfrow=c(1,2))  # This sets up a 1x2 grid for side-by-side histograms
# Histogram for talkergroup_final == 0
hist(summary_behavioral_hist$Average_accuracy[summary_behavioral_hist$talkergroup_final == 0], 
     main = "Histogram for CWNS",
     xlab = "accuracy",
     ylab = "Frequency",
     col = "blue",
     border = "black",
     xlim = c(0, 100), 
     ylim = c(0, 50),  
     breaks = 12)
# Histogram for talkergroup_final == 1
hist(summary_behavioral_hist$Average_accuracy[summary_behavioral_hist$talkergroup_final == 1], 
     main = "Histogram for CWS",
     xlab = "accuracy",
     ylab = "Frequency",
     col = "red",  # Use a different color for the second group
     border = "black",
     xlim = c(0, 100), 
     ylim = c(0, 50),  
     breaks = 12)
# Reset the plotting to a single plot
par(mfrow=c(1,1))

# Scatterplot of all accuracy across all participants
scatterplot <- ggplot(summary_behavioral_hist, aes(x = Subject, y = Average_accuracy, color = StimTag)) +
  geom_point() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10))
plot(scatterplot)


# Premature responses Histogram:
# Create a new plot
par(mfrow=c(1,2))  
# Histogram for talkergroup_final == 0
hist(summary_behavioral_hist$Average_premature_responses[summary_behavioral_hist$talkergroup_final == 0], 
     main = "Histogram for CWNS",
     xlab = "premature_responses",
     ylab = "Frequency",
     col = "blue",
     border = "black",
     xlim = c(0, 50), 
     ylim = c(0, 150),  
     breaks = 12)
# Histogram for talkergroup_final == 1
hist(summary_behavioral_hist$Average_premature_responses[summary_behavioral_hist$talkergroup_final == 1], 
     main = "Histogram for CWS",
     xlab = "premature_responses",
     ylab = "Frequency",
     col = "red",  # Use a different color for the second group
     border = "black",
     xlim = c(0, 50), 
     ylim = c(0, 150),  
     breaks = 12)
# Reset the plotting to a single plot
par(mfrow=c(1,1))

# Scatterplot of all accuracy across all participants
scatterplot <- ggplot(summary_behavioral_hist, aes(x = Subject, y = Average_premature_responses, color = StimTag)) +
  geom_point() +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, by = 10))
plot(scatterplot)


#Reaction Time Histogram:
# Create a new plot
par(mfrow=c(1,2))  
# Histogram for talkergroup_final == 0
hist(summary_behavioral_hist$Average_RT[summary_behavioral_hist$talkergroup_final == 0], 
     main = "Histogram for CWNS",
     xlab = "reaction_time",
     ylab = "Frequency",
     col = "blue",
     border = "black",
     xlim = c(100, 2000), 
     ylim = c(0, 50),  
     breaks = 12)
# Histogram for talkergroup_final == 1
hist(summary_behavioral_hist$Average_RT[summary_behavioral_hist$talkergroup_final == 1], 
     main = "Histogram for CWS",
     xlab = "reaction_time",
     ylab = "Frequency",
     col = "red",  # Use a different color for the second group
     border = "black",
     xlim = c(100, 2000), 
     ylim = c(0, 50),  
     breaks = 12)
# Reset the plotting to a single plot
par(mfrow=c(1,1))

# Scatterplot of all reaction time across all participants
scatterplot <- ggplot(summary_behavioral_hist, aes(x = Subject, y = Average_RT, color = StimTag)) +
  geom_point() +
  scale_y_continuous(limits = c(200, 2000), breaks = seq(200, 2000, by = 200))
plot(scatterplot)

```


# BARPLOTS FOR BEHAVIORAL DATA:

```{r}

# Create the Dataframe to get the behavioral data
summary_behavioral <- 
  ZOO_FCz_Pz%>%
  group_by(talkergroup_final, Emotion, Condition) %>%
  summarise(
    Average_accuracy = mean(accuracy, na.rm = TRUE),
    SEM_accuracy = sd(accuracy, na.rm = TRUE) / sqrt(n()),
    Average_premature_responses = mean(premature_responses, na.rm = TRUE),
    SEM_premature_responses = sd(premature_responses, na.rm = TRUE) / sqrt(n()),
    Average_RT_proper = mean(RT_proper, na.rm = TRUE),
    SEM_RT_proper = sd(RT_proper, na.rm = TRUE) / sqrt(n()),
    )

# Rename some factors for better visuals:
summary_behavioral$talkergroup_final <- factor(summary_behavioral$talkergroup_final, levels = c(0, 1), labels = c("CWNS", "CWS"))
summary_behavioral$Emotion <- factor(summary_behavioral$Emotion, levels = c("Neg", "Neut"), labels = c("Affective", "Neutral"))


# BAR PLOT FOR ACCURACY
bar_plot <- ggplot(summary_behavioral, aes(x = Emotion, y = Average_accuracy, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_errorbar(aes(ymin = Average_accuracy - SEM_accuracy, ymax = Average_accuracy + SEM_accuracy), width = 0.2, position = position_dodge(width = 0.7)) +
  labs(x = "Emotion", y = "Average Accuracy (%)") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) +
  scale_fill_manual(values = c("royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered"))
# ggtitle("Average Accuracy by Emotion and Condition for CWS and CWNS") 
bar_plot <- bar_plot + coord_cartesian(ylim = c(50, 100))
print(bar_plot)

# BAR PLOT FOR PREMATURE RESPONSES
bar_plot <- ggplot(summary_behavioral, aes(x = Emotion, y = Average_premature_responses, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_errorbar(aes(ymin = Average_premature_responses - SEM_premature_responses, ymax = Average_premature_responses + SEM_premature_responses), width = 0.2, position = position_dodge(width = 0.7)) +
  labs(x = "Emotion", y = "Average_premature_responses (%)") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) +
  scale_fill_manual(values = c("royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered"))
# ggtitle("Average Accuracy by Emotion and Condition for CWS and CWNS") 
bar_plot <- bar_plot + coord_cartesian(ylim = c(0, 10))
print(bar_plot)


  
# BAR PLOT FOR REACTION TIME - both go and nogo
bar_plot <- ggplot(summary_behavioral, aes(x = Emotion, y = Average_RT_proper, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_errorbar(aes(ymin = Average_RT_proper - SEM_RT_proper, ymax = Average_RT_proper + SEM_RT_proper), width = 0.2, position = position_dodge(width = 0.7)) +
  labs(x = "Emotion", y = "Average Reaction Time (ms)") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) +
  scale_fill_manual(values = c("royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered"))
# ggtitle("Average Accuracy by Emotion and Condition for CWS and CWNS") 
bar_plot <- bar_plot + coord_cartesian(ylim = c(500, 850))
print(bar_plot)


# BAR PLOT FOR REACTION TIME - GO ONLY
summary_behavioral_Go <- subset(summary_behavioral, Condition == "Go")

bar_plot <- ggplot(summary_behavioral_Go, aes(x = Emotion, y = Average_RT_proper)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5, fill ='royalblue2') +
  geom_errorbar(aes(ymin = Average_RT_proper - SEM_RT_proper, ymax = Average_RT_proper + SEM_RT_proper), width = 0.2, position = position_dodge(width = 0.9)) +
  labs(x = "Emotion", y = "Average Reaction Time (ms)") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) 
# ggtitle("Average Accuracy by Emotion and Condition for CWS and CWNS") 
bar_plot <- bar_plot + coord_cartesian(ylim = c(500, 850))
print(bar_plot)

```

# BEHAVIORAL ANALYSES - ACCURACY:

```{r}
# ACCURACY
model1 <- lmer(accuracy ~ talkergroup_final*Emotion*Condition + 
                 calculator_gender_cve + calculator_age_cve  + (1|Subject), data = ZOO_FCz_Pz, REML = TRUE)
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final"))  

emmeans_result <- emmeans(model1, pairwise ~  talkergroup_final | Emotion | Condition) # Tukey is default
pairs(emmeans_result, adjust= "none", simple = "each")   # adjust = "bonferroni"

emmeans_resultCondition <- emmeans(model1, pairwise ~ Condition) 
emmeans_resultCondition
emmeans_resulttalkergroupEmotion <- emmeans(model1, pairwise ~ talkergroup_final|Emotion) 
emmeans_resulttalkergroupEmotion
pairs(emmeans_resulttalkergroupEmotion, adjust = "none", simple = "each") 
emmeans_resulttalkergroup <- emmeans(model1, pairwise ~ talkergroup_final) 
emmeans_resulttalkergroup
emmeans_resulttalkergroupCond <- emmeans(model1, pairwise ~ talkergroup_final|Condition) 
emmeans_resulttalkergroupCond
pairs(emmeans_resulttalkergroupCond, adjust = "none", simple = "each") 
emmeans_resulttalkergroupCondEmo <- emmeans(model1, pairwise ~ talkergroup_final|Condition|Emotion) 
emmeans_resulttalkergroupCondEmo
pairs(emmeans_resulttalkergroupCondEmo, adjust = "none", simple = "each")
```

# BEHAVIORAL ANALYSES - PREMATURE RESPONSES:

```{r}
# PREMATURE RESPONSES
model1 <- lmer(premature_responses ~ talkergroup_final*Emotion*Condition + 
                 calculator_gender_cve + calculator_age_cve  + (1|Subject), data = ZOO_FCz_Pz, REML = TRUE)
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final"))  

emmeans_result <- emmeans(model1, pairwise ~  talkergroup_final | Condition) # Tukey is default
pairs(emmeans_result, adjust= "none", simple = "each")   # adjust = "bonferroni"

emmeans_resultCondition <- emmeans(model1, pairwise ~ Condition) 
emmeans_resultCondition
emmeans_resulttalkergroupEmotion <- emmeans(model1, pairwise ~ talkergroup_final|Emotion) 
emmeans_resulttalkergroupEmotion
pairs(emmeans_resulttalkergroupEmotion, adjust = "none", simple = "each") 
emmeans_resulttalkergroup <- emmeans(model1, pairwise ~ talkergroup_final) 
emmeans_resulttalkergroup
emmeans_resulttalkergroupCond <- emmeans(model1, pairwise ~ talkergroup_final|Condition) 
emmeans_resulttalkergroupCond
pairs(emmeans_resulttalkergroupCond, adjust = "none", simple = "each") 
emmeans_resulttalkergroupCondEmo <- emmeans(model1, pairwise ~ talkergroup_final|Condition|Emotion) 
emmeans_resulttalkergroupCondEmo
pairs(emmeans_resulttalkergroupCondEmo, adjust = "none", simple = "each") 
```

# BEHAVIORAL ANALYSES - REACTION TIME:

```{r}
ZOO_FCz_Pz_GO <- subset(ZOO_FCz_Pz, Condition == 'Go')
ZOO_FCz_Pz_NOGO <- subset(ZOO_FCz_Pz, Condition == 'NoGo')


model1 <- lmer(RT_proper ~ talkergroup_final*Emotion + 
                 calculator_gender_cve + calculator_age_cve  + (1|Subject), data = ZOO_FCz_Pz_GO, REML = TRUE)
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "talkergroup_final"))  

emmeans_result <- emmeans(model1, pairwise ~  talkergroup_final | Emotion) # Tukey is default
pairs(emmeans_result, adjust= "none", simple = "each")   # adjust = "bonferroni"



model1 <- lmer(RT_proper ~ talkergroup_final*Emotion + 
                 calculator_gender_cve + calculator_age_cve  + (1|Subject), data = ZOO_FCz_Pz_NOGO, REML = TRUE)
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "talkergroup_final"))  

emmeans_result <- emmeans(model1, pairwise ~  talkergroup_final | Emotion) # Tukey is default
pairs(emmeans_result, adjust= "none", simple = "each")   # adjust = "bonferroni"



model1 <- aov(RT_proper ~ talkergroup_final*Emotion + calculator_age_cve +calculator_gender_cve + Error(Subject/(Emotion)), data = ZOO_FCz_Pz_GO)
summary(model1)


```
# P2 is an event-related potential (ERP) component in electroencephalography (EEG) studies. It is a positive-going wave that occurs approximately 200 milliseconds (ms) after the onset of a stimulus. In the context of a Go/NoGo task, the P2 component is often associated with early attentional processing of the stimuli. Studies have shown that the amplitude of the P2 component can be larger for NoGo trials compared to Go trials, indicating that more attentional resources are allocated to the process of inhibiting a response.

# N2 ERP component is a negative-going event-related potential that is typically observed in a time window approximately 200-350 ms after the onset of a stimulus. It is generally linked with conflict monitoring, error detection, and response inhibition processes in cognitive control tasks. It is also often seen in tasks that require the detection of rare or unexpected events, hence it is sometimes referred to as the "mismatch negativity" or "surprise" signal.

```{r}
# Without random subject
model1 <- aov(MeanAmp_N2P2 ~ (talkergroup_final*Emotion*Condition) + calculator_gender_cve + calculator_age_cve + Error(Subject/(Emotion*Condition)), data = ZOO_FCz_Pz)
summary(model1)


# LATERALITY INCLUDED (MAIN EFFECT OF EMOTION)
model1 <- lmer(MeanAmp_N2P2 ~ talkergroup_final*Emotion*Condition*Laterality + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_good, REML = TRUE) 
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final")) 
plot_model(model1, type="pred", terms = c("Laterality")) 
plot_model(model1, type="pred", terms = c("Emotion")) 


model2 <- lmer(MeanAmp_N2P2 ~ talkergroup_final*Emotion*Condition + Laterality + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_good, REML = TRUE) 
anova(model2)


# MIDDLE (NO MAIN EFFECT OF EMOTION)
model1 <- lmer(MeanAmp_N2P2 ~ (talkergroup_final*Emotion*Condition) + calculator_gender_cve + calculator_age_cve + (1+Emotion+Condition|Subject), data = ZOO_FCz_Pz, REML = TRUE)
anova(model1) 

model1 <- lmer(MeanAmp_N2P2 ~ talkergroup_final*Emotion*Condition + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_FCz_Pz, REML = TRUE) #by including `(1|Subject)` in your model, you are taking into account the repeated measures nature of the `Condition` and `Emotion` variables.
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final")) 


# RIGHT SIDE: (MAIN EFFECT OF EMOTION)
ZOO_good_rightside <- subset(ZOO_good, Laterality = 'Right')
  
model1 <- lmer(MeanAmp_N2P2 ~ talkergroup_final*Emotion*Condition + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_good_rightside, REML = TRUE) 
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final")) 
plot_model(model1, type="pred", terms = c("Emotion")) 


# LEFT SIDE: (MAIN EFFECT OF EMOTION)
ZOO_good_leftside <- subset(ZOO_good, Laterality = 'Left')
  
model1 <- lmer(MeanAmp_N2P2 ~ talkergroup_final*Emotion*Condition + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_good_leftside, REML = TRUE) 
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final")) 
plot_model(model1, type="pred", terms = c("Emotion")) 




emmeans_resulttalkergroupCondEmo <- emmeans(model1, pairwise ~ talkergroup_final|Condition|Emotion) 
emmeans_resulttalkergroupCondEmo
pairs(emmeans_resulttalkergroupCondEmo, adjust = "none", simple = "each") # ,adjust = "bonferroni")


# Calculate marginal means for the three-way interaction
means <- as.data.frame(emmeans(model1, specs = ~ talkergroup_final:Emotion:Condition))

# Rename the levels of the "talkergroup_final" and "Emotion" factors
means$talkergroup_final <- factor(means$talkergroup_final, levels = c(0, 1), labels = c("CWNS", "CWS"))
means$Emotion <- factor(means$Emotion, levels = c("Neg", "Neut"), labels = c("Affective", "Neutral"))

bar_plot <-  ggplot(means, aes(x = Emotion, y = emmean, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position = position_dodge(0.9)) +
  labs(x = "Emotion", y = "Mean N2-P2 in μV") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) + 
scale_fill_manual(values = c("royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered"))

print(bar_plot)


# Calculate AIC for model1
aic_model1 <- AIC(model1)
# Calculate AIC for model2
aic_model2 <- AIC(model2)
# Compare AIC values
if (aic_model1 < aic_model2) {
  cat("Model 1 is preferred (lower AIC)\n")
} else if (aic_model2 < aic_model1) {
  cat("Model 2 is preferred (lower AIC)\n")
} else {
  cat("Both models have similar AIC\n")
}


```

# P3 (or P300) component is a positive-going event-related potential (ERP) in electroencephalography (EEG) that typically occurs around 300 milliseconds (ms) after the onset of a stimulus, hence the name P300.

# In the context of a Go/NoGo task, P3 is often associated with cognitive processing involved in decision making and response execution or inhibition. More specifically:

# 1. P3a: This component is thought to reflect attention-related processes and is typically elicited by infrequent and unexpected stimuli, including NoGo stimuli in a Go/NoGo task. It is usually observed at frontal and central electrode sites.
# 2. P3b: This component is usually elicited by target stimuli in tasks that require a response, such as the Go stimuli in a Go/NoGo task. It is typically observed at parietal electrode sites and is thought to reflect processes related to memory updating and context closure.

# The P3 (P300) component is often associated with cognitive processes such as attention, decision making, and response execution or inhibition. In a Go/NoGo task, the NoGo trials require more cognitive resources as the participant must inhibit a prepotent response. This cognitive demand often results in a larger P3 component for NoGo trials.

# However, it's important to note that the specifics can vary depending on the individual and the exact design of the task. For instance, if the NoGo trials are very infrequent, the P3 amplitude might also be influenced by the novelty or surprise of these trials.


```{r}

# LATERALITY -  LATERALITY TALKERGROUP INTERACTION
model1 <- lmer(MeanAmp_P3 ~ talkergroup_final*Emotion*Condition*Laterality + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_good, REML = TRUE) 
anova(model1)
plot_model(model1, type="pred", terms = c("Laterality", "talkergroup_final")) 
plot_model(model1, type="pred", terms = c("Condition"))
plot_model(model1, type="pred", terms = c("Laterality"))
# plot_model(model1, type="pred", terms = c("Laterality", "Condition", "talkergroup_final")) 



# MIDDLE - CONDITION ONLY
model1 <- lmer(MeanAmp_P3 ~ talkergroup_final*Emotion*Condition + calculator_gender_cve + calculator_age_cve + 
                 (1|Subject), data = ZOO_FCz_Pz, REML = TRUE) 
anova(model1)
plot_model(model1, type="pred", terms = c("Emotion" , "Condition", "talkergroup_final")) 


# Calculate marginal means for NONEXISTENT the three-way interaction
means <- as.data.frame(emmeans(model1, specs = ~ talkergroup_final:Emotion:Condition))

# Rename the levels of the "talkergroup_final" factor
means$talkergroup_final <- factor(means$talkergroup_final, levels = c(0, 1), labels = c("CWNS", "CWS"))
means$Emotion <- factor(means$Emotion, levels = c("Neg", "Neut"), labels = c("Affective", "Neutral"))

bar_plot <-  ggplot(means, aes(x = Emotion, y = emmean, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position = position_dodge(0.9)) +
  labs(x = "Emotion", y = "Mean P3 in μV") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) + 
scale_fill_manual(values = c("royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered", "royalblue2", "orangered"))

bar_plot <- bar_plot + coord_cartesian(ylim = c(4, 12))
print(bar_plot)




bar_plot <-  ggplot(means, aes(x = Condition, y = emmean, fill = Emotion)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position = position_dodge(0.9)) +
  labs(x = "Condition", y = "Mean P3 in μV") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) + 
scale_fill_manual(values = c("springgreen3", "royalblue2", "springgreen3", "royalblue2", "springgreen3", "royalblue2", "springgreen3", "royalblue2"))

bar_plot <- bar_plot + coord_cartesian(ylim = c(4, 12))
print(bar_plot)




# GO CONDITION ONLY!  
ZOO_FCz_Pz_GO <- subset(ZOO_FCz_Pz, Condition == "Go")

model1 <- aov(MeanAmp_P3 ~ talkergroup_final*Emotion + calculator_gender_cve + calculator_age_cve, data = ZOO_FCz_Pz_GO)
summary(model1)

model1 <- lmer(MeanAmp_P3 ~ talkergroup_final*Emotion  + calculator_age_cve + calculator_gender_cve +   
                 (1|Subject), data = ZOO_FCz_Pz_GO, REML = TRUE)
anova(model1)

plot_model(model1, type="pred", terms = c("Emotion"))
plot_model(model1, type="pred", terms = c("Emotion", "talkergroup_final"))


# Calculate marginal means for the three-way interaction
means <- as.data.frame(emmeans(model1, specs = ~ talkergroup_final:Emotion))
# filtered_means <- means[means$Condition == "Go", ] # keep all columns

means$talkergroup_final <- factor(means$talkergroup_final, levels = c(0, 1), labels = c("CWNS", "CWS"))
means$Emotion <- factor(means$Emotion, levels = c("Neg", "Neut"), labels = c("Affective", "Neutral"))

bar_plot <-  ggplot(means, aes(x = Emotion, y = emmean)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position = position_dodge(0.9)) +
  labs(x = "Emotion", y = "Mean P3 in μV") +
  facet_grid(. ~ talkergroup_final) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14),
    legend.title =element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", vjust = 2),
    strip.text = element_text(size = 14, face = "bold")) +
scale_fill_manual(values = c("springgreen3", "royalblue2", "springgreen3", "royalblue2"))

print(bar_plot)


```




# PREDICTING ACCURACY USING ERP MEASURES:


```{r}

collapsed_accuracy <- 
  ZOO_FCz_Pz %>%
  group_by(Subject, talkergroup_final, Condition) %>%
  summarise(
    accuracy = mean(accuracy, na.rm = TRUE),
    calculator_age_cve = mean(calculator_age_cve, na.rm = TRUE),
    calculator_gender_cve = mean(calculator_gender_cve, na.rm = TRUE),
    MeanAmp_N2P2 = mean(MeanAmp_N2P2, na.rm = TRUE),
    MeanAmp_P3 = mean(MeanAmp_P3, na.rm = TRUE),
    MeanAmp_P2 = mean(MeanAmp_P2, na.rm = TRUE),
    Latency_N2 = mean(Latency_N2, na.rm = TRUE),
    Latency_P3 = mean(Latency_P3, na.rm = TRUE),
    Latency_P2 = mean(Latency_P2, na.rm = TRUE)
    )


model1 <- lmer(accuracy ~ talkergroup_final*Condition + MeanAmp_N2P2 + MeanAmp_P3 +MeanAmp_P2 + Latency_N2 + Latency_P3 + Latency_P2 + calculator_age_cve+calculator_gender_cve  + (1|Subject),  
              data = collapsed_accuracy)
anova(model1)
AIC(model1)

model2 <- aov(accuracy ~ talkergroup_final*Condition + MeanAmp_N2P2 + MeanAmp_P3 +MeanAmp_P2 + Latency_N2 + Latency_P3 + Latency_P2 + calculator_age_cve+calculator_gender_cve +
                Error(Subject/Condition), data = collapsed_accuracy)
summary(model2)

# Check the residuals of your chosen model to ensure they are normally distributed and homoscedastic. If they are not, you may need to consider transformations of your dependent variable or a different type of model.


model1 <- lmer(accuracy ~ talkergroup_final*Condition*MeanAmp_P3 + calculator_age_cve+calculator_gender_cve  + (1|Subject),  
              data = collapsed_accuracy)
anova(model1)


```
# MODERATOR ANALYSIS WITH ALL CORTICAL MEASURES:

```{r}
#MODERATOR ANALYSIS WITH ALL CORTICAL MEASURES:

# Select columns from df1
selected_df1 <- select(ZOO_FCz_Pz, Subject, talkergroup_final, accuracy, calculator_age_cve, Condition, Emotion, MeanAmp_N2P2, MeanAmp_N2, MeanAmp_P2, MeanAmp_P3, Latency_N2, Latency_P2, Latency_P3) 
# Converting into numerical variable:
encoded_data1 <- model.matrix(~ Condition + 0, data = selected_df1)
encoded_data2 <- model.matrix(~ Emotion + 0, data = selected_df1)


# Combine the original dataframe with the encoded and scaled variables
merged_df1 <- cbind(selected_df1, encoded_data1, encoded_data2)
merged_df2 <- subset(merged_df1, select = -c(Subject, ConditionNoGo, EmotionNeut, Condition, Emotion))

# Scaling the variables
# Specify the columns you want to scale
columns_to_scale <- c("MeanAmp_N2P2", "MeanAmp_N2", "MeanAmp_P2","MeanAmp_P3", "Latency_N2","Latency_P2", "Latency_P3")

# Subset the data frame to include only the columns you want to scale
subset_df <- merged_df2[, columns_to_scale]

# Scale the selected columns
scaled_subset_df <- as.data.frame(scale(subset_df))

# subjects <- subset(merged_df1, select = c(Subject))

# Get the Unscaled columns + Subjects Column
merged_df1_small <- subset(merged_df1, select = c( Subject, talkergroup_final, accuracy, calculator_age_cve, ConditionGo, EmotionNeg))

# Combine the scaled subset with the original data frame
final_merged <- cbind(merged_df1_small, scaled_subset_df)

# Rename condition and emotion
final_merged <- final_merged %>%
  rename(Condition = ConditionGo, Emotion = EmotionNeg)


model1 <- lmer(accuracy ~ talkergroup_final*Condition*Emotion + MeanAmp_N2P2 + MeanAmp_P3 +MeanAmp_P2 + Latency_N2 + Latency_P3 + Latency_P2 + calculator_age_cve  + (1|Subject),  
              data = final_merged)
anova(model1)
AIC(model1)


model1 <- lmer(accuracy ~ talkergroup_final*Condition*Emotion*MeanAmp_P3 + calculator_age_cve  + (1|Subject),  
              data = final_merged)
anova(model1)

plot1 <- plot_model(model1, type='pred', terms = c("MeanAmp_P3", "Emotion", "talkergroup_final"))  + aes(linetype = group, color = group) +
  theme_bw() +
  labs(x = "Mean P3 Amplitude (Scaled)",  y = "Accuracy (%)", fill = "talkergroup_final")+
  theme(axis.title.x = element_text(family="Arial", color = "grey20", size = 14, angle = 0),
        axis.title.y = element_text(family="Arial", color = "grey20", size = 14, angle = 90),
        axis.text.x = element_text(family="Arial", color = "grey20", size = 12, angle = 0),
        axis.text.y = element_text(family="Arial", color = "grey20", size = 12, angle = 0),
        legend.text = element_text(family="Arial", color = "grey20", size = 12, angle = 0),
        title = element_blank(),
        legend.title = element_blank())+
  scale_color_manual(values = c("mediumpurple1", "springgreen3"), labels = c("Neutral", "Affective")) +
  scale_fill_manual(values = c("mediumpurple1", "springgreen3"), labels = c("Neutral", "Affective")) 

print(plot1)




#FIT MULTIPLE LINEAR MODELS FOR EACH TALKERGROUP AND EMOTION

# Create an empty data frame to store the results
results_df <- data.frame(
  Emotion = character(),
  TalkerGroup = character(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)

# Create a subset of your data for each combination of emotion and talkergroup
subsets <- final_merged %>%
  filter(Emotion %in% c(0,1), talkergroup_final %in% c(0, 1))

# Loop through each combination and extract the p-values
for (emotion in unique(subsets$Emotion)) {
  for (group in unique(subsets$talkergroup_final)) {
    subset_data <- subsets %>%
      filter(Emotion == emotion, talkergroup_final == group)
    
    # Fit a linear regression model for the current combination
    model <- lm(accuracy ~ MeanAmp_P3, data = subset_data)
    
    # Extract the p-value
    p_value <- summary(model)$coefficients[2, 4]  # Assumes MeanAmp_P3 is the second coefficient
    
    # Create a data frame with the results
    result_row <- data.frame(
      Emotion = emotion,
      TalkerGroup = paste("talkergroup", group),
      P_Value = p_value
    )
    
    # Append the results to the results data frame
    results_df <- rbind(results_df, result_row)
  }
}

# Print the results
print(results_df)


```


# CORRELATIONS BETWEEN ERPs and ACCURACY
```{r}

ZOO_Corr_NoGo_Neg_CWS <- subset(ZOO_FCz_Pz, Condition == "NoGo" & Emotion == "Neg" & talkergroup_final == 1)
ZOO_Corr_NoGo_Neut_CWS <- subset(ZOO_FCz_Pz, Condition == "NoGo" & Emotion == "Neut" & talkergroup_final == 1)
ZOO_Corr_Go_Neg_CWS <- subset(ZOO_FCz_Pz, Condition == "Go" & Emotion == "Neg" & talkergroup_final == 1)
ZOO_Corr_Go_Neut_CWS <- subset(ZOO_FCz_Pz, Condition == "Go" & Emotion == "Neut" & talkergroup_final == 1)

ZOO_Corr_NoGo_Neg_CWNS <- subset(ZOO_FCz_Pz, Condition == "NoGo" & Emotion == "Neg" & talkergroup_final == 0)
ZOO_Corr_NoGo_Neut_CWNS <- subset(ZOO_FCz_Pz, Condition == "NoGo" & Emotion == "Neut" & talkergroup_final == 0)
ZOO_Corr_Go_Neg_CWNS <- subset(ZOO_FCz_Pz, Condition == "Go" & Emotion == "Neg" & talkergroup_final == 0)
ZOO_Corr_Go_Neut_CWNS <- subset(ZOO_FCz_Pz, Condition == "Go" & Emotion == "Neut" & talkergroup_final == 0)

rownames(ZOO_Corr_NoGo_Neg_CWS) <- NULL
rownames(ZOO_Corr_NoGo_Neut_CWS) <- NULL
rownames(ZOO_Corr_Go_Neg_CWS) <- NULL
rownames(ZOO_Corr_Go_Neut_CWS) <- NULL
rownames(ZOO_Corr_NoGo_Neg_CWNS) <- NULL
rownames(ZOO_Corr_NoGo_Neut_CWNS) <- NULL
rownames(ZOO_Corr_Go_Neg_CWNS) <- NULL
rownames(ZOO_Corr_Go_Neut_CWNS) <- NULL



#DRAW CORRELATION PLOTS###########################

correlation_analysis <- function(df1, df2, var1, var2) {

# Perform the correlation test
correlation_CWS <- cor.test(df1[[var1]], df1[[var2]], use="complete.obs") #exclude pairs with missing values
correlation_CWNS <- cor.test(df2[[var1]], df2[[var2]], use="complete.obs")

# Create a scatter plot with a regression line and confidence interval
# use `aes_string()` or aes with !!sym  when you're passing variable names as strings.
title <- paste(deparse(substitute(df1)), "and", deparse(substitute(df2)))

ggplot() +
geom_point(data = df1, aes(x = !!sym(var1), y = !!sym(var2)), color = "red") +
geom_smooth(data = df1, aes(x = !!sym(var1), y = !!sym(var2)), method = "lm", se = TRUE, col = "red") +
geom_point(data = df2, aes(x = !!sym(var1), y = !!sym(var2)), color = "blue") +
geom_smooth(data = df2, aes(x = !!sym(var1), y = !!sym(var2)), method = "lm", se = TRUE, col = "blue") +
labs(title = title, x = "ERP Amplitude (µV)", y = "Accuracy (%)") +
theme_minimal() + # Set background to white
theme(panel.grid.major = element_blank(), # Remove major grid lines
panel.grid.minor = element_blank(), # Remove minor grid lines
axis.line = element_line(color = "black"),
axis.text = element_text(size = 14), # Increase font size for both axis labels and tick labels
axis.title = element_text(size = 16)) + # Increase font size for axis labels
ylim(40, 110) + # Replace ymin_value and ymax_value with your desired limits
annotate("text", x = mean(df1[[var1]]), y = max(df1[[var2]]) + 5,
label = paste("CWS r =", round(correlation_CWS$estimate, 3)), vjust = -1, col = "red") +
annotate("text", x = mean(df1[[var1]]), y = max(df1[[var2]]),
label = paste("p-value =", round(correlation_CWS$p.value, 3)), vjust = -1, col = "red") +
annotate("text", x = mean(df2[[var1]]), y = min(df2[[var2]]) + 5,
label = paste("CWNS r =", round(correlation_CWNS$estimate, 3)), vjust = -1, col = "blue") +
annotate("text", x = mean(df2[[var1]]), y = min(df2[[var2]]),
label = paste("p-value =", round(correlation_CWNS$p.value, 3)), vjust = -1, col = "blue") +
theme(legend.position = "none")
}

correlation_analysis(ZOO_Corr_NoGo_Neg_CWS, ZOO_Corr_NoGo_Neg_CWNS, "MeanAmp_N2P2", "accuracy")
correlation_analysis(ZOO_Corr_NoGo_Neut_CWS, ZOO_Corr_NoGo_Neut_CWNS, "MeanAmp_N2P2", "accuracy")
correlation_analysis(ZOO_Corr_Go_Neg_CWS, ZOO_Corr_Go_Neg_CWNS, "MeanAmp_N2P2", "accuracy")
correlation_analysis(ZOO_Corr_Go_Neut_CWS, ZOO_Corr_Go_Neut_CWNS, "MeanAmp_N2P2", "accuracy")


correlation_analysis(ZOO_Corr_NoGo_Neg_CWS, ZOO_Corr_NoGo_Neg_CWNS, "MeanAmp_P3", "accuracy")
correlation_analysis(ZOO_Corr_NoGo_Neut_CWS, ZOO_Corr_NoGo_Neut_CWNS, "MeanAmp_P3", "accuracy")
correlation_analysis(ZOO_Corr_Go_Neg_CWS, ZOO_Corr_Go_Neg_CWNS, "MeanAmp_P3", "accuracy")
correlation_analysis(ZOO_Corr_Go_Neut_CWS, ZOO_Corr_Go_Neut_CWNS, "MeanAmp_P3", "accuracy")

#PERSONALIZED PLOT######
correlation_CWNS_Neg_GO <- cor.test(ZOO_Corr_NoGo_Neg_CWS$MeanAmp_P3, ZOO_Corr_NoGo_Neg_CWS$accuracy)
correlation_CWNS_Neg_NOGO <- cor.test(ZOO_Corr_NoGo_Neg_CWNS$MeanAmp_P3, ZOO_Corr_NoGo_Neg_CWNS$accuracy)

# Create a scatter plot with a regression line and confidence interval
ggplot() +
geom_point(data = ZOO_Corr_NoGo_Neg_CWS, aes(x = MeanAmp_P3, y = accuracy), color = "blue") +
geom_smooth(data = ZOO_Corr_NoGo_Neg_CWS, aes(x = MeanAmp_P3, y = accuracy), method = "lm", se = TRUE, col = "blue") +
geom_point(data = ZOO_Corr_NoGo_Neg_CWNS, aes(x = MeanAmp_P3, y = accuracy), color = "red") +
geom_smooth(data = ZOO_Corr_NoGo_Neg_CWNS, aes(x = MeanAmp_P3, y = accuracy), method = "lm", se = TRUE, col = "red") +
labs(title = "CWNS in Affective GO and NOGO", x = "P3 Amplitude (µV)", y = "Accuracy (%)") +
theme_minimal() + # Set background to white
theme(panel.grid.major = element_blank(), # Remove major grid lines
panel.grid.minor = element_blank(), # Remove minor grid lines
axis.line = element_line(color = "black"),
axis.text = element_text(size = 14), # Increase font size for both axis labels and tick labels
axis.title = element_text(size = 16)) + # Increase font size for axis labels
ylim(40, 110) + # Replace ymin_value and ymax_value with your desired limits
annotate("text", x = mean(ZOO_Corr_NoGo_Neg_CWS$MeanAmp_P3), y = max(ZOO_Corr_NoGo_Neg_CWS$accuracy) + 5,
label = paste("Affective GO r =", round(correlation_CWNS_Neg_GO$estimate, 3)), vjust = -1, col = "blue") +
annotate("text", x = mean(ZOO_Corr_NoGo_Neg_CWS$MeanAmp_P3), y = max(ZOO_Corr_NoGo_Neg_CWS$accuracy),
label = paste("p-value =", round(correlation_CWNS_Neg_GO$p.value, 3)), vjust = -1, col = "blue") +
annotate("text", x = mean(ZOO_Corr_NoGo_Neg_CWNS$MeanAmp_P3), y = min(ZOO_Corr_NoGo_Neg_CWNS$accuracy) + 5,
label = paste("Affective NOGO r =", round(correlation_CWNS_Neg_NOGO$estimate, 3)), vjust = -1, col = "red") +
annotate("text", x = mean(ZOO_Corr_NoGo_Neg_CWNS$MeanAmp_P3), y = min(ZOO_Corr_NoGo_Neg_CWNS$accuracy),
label = paste("p-value =", round(correlation_CWNS_Neg_NOGO$p.value, 3)), vjust = -1, col = "red") +
theme(legend.position = "none")

```





